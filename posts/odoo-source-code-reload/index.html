<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
<title>odooæºç é˜…è¯»ä¹‹è‡ªåŠ¨é‡è½½çš„å®ç°</title>
<meta name="description" 
      content=""
>

  




<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link
  rel="alternate"
  type="application/rss+xml"
  href="https://eoyohe.cn/index.xml"
  title="chemf"
/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="odooæºç é˜…è¯»ä¹‹è‡ªåŠ¨é‡è½½çš„å®ç°"/>
<meta name="twitter:description" content="åˆ©ç”¨ watchdog ä¹‹ç±»æ–‡ä»¶ç³»ç»Ÿ apiï¼Œå®ç°ä»£ç çƒ­é‡è½½æ”¯æŒ"/>



<link rel="stylesheet" href="https://eoyohe.cn/fontawesome/css/all.min.css" />




<link
  crossorigin="anonymous"
  href="/css/styles.min.css"
  integrity=""
  rel="preload stylesheet"
  as="style"
/>




<link
  id="dark-mode-theme"
  crossorigin="anonymous"
  href="/css/dark.min.css"
  integrity=""
  rel="preload stylesheet"
  as="style"
/>


<script>
  var darkTheme = document.getElementById('dark-mode-theme')
  var storedTheme = localStorage.getItem('dark-mode-storage')

  if (storedTheme === 'dark') {
    darkTheme.disabled = false
  } else if (storedTheme === 'light') {
    darkTheme.disabled = true
  }
</script>


<script defer crossorigin="anonymous" src="/js/theme.js" integrity=""></script>


<script defer crossorigin="anonymous" src="/js/instantpage.min.js" integrity=""></script><meta name="generator" content="Hugo 0.83.1" />
  </head>
  <body>
    
  




  <header>
    <nav class="navbar">
  <div class="nav">
    

    <ul class="nav-links">
      
    </ul>
  </div>
</nav>

    <div class="intro-header">
      <div class="container">
        <div class="posts-heading">
          
            <h1>
              odooæºç é˜…è¯»ä¹‹è‡ªåŠ¨é‡è½½çš„å®ç°
            </h1>
          
          
        </div>
      </div>
    </div>
  </header>
  

    
  <div class="container" role="main">
    <article class="article" class="blog-post">
      
  <p>åœ¨é˜…è¯»æºç çš„æ—¶å€™å‘ç°åŸæ¥odooæ˜¯æœ‰é‡è½½ä»£ç çš„å®ç°çš„, åŠ ä¸Šä¸Šä¸€ç¯‡çš„æ¨¡å—è¿œç¨‹éƒ¨ç½²æ›´æ–°åŠŸèƒ½,ç»„åˆå¯ä»¥å®ç°åœ¨ç»ˆç«¯ä¸Šé‡è½½æœåŠ¡å™¨äº†.</p>
<h2 id="odooæœåŠ¡å™¨å¯åŠ¨è¿‡ç¨‹">odooæœåŠ¡å™¨å¯åŠ¨è¿‡ç¨‹</h2>
<p>åœ¨odooçš„serverå¯åŠ¨è¿‡ç¨‹ä¸­, é¦–å…ˆæ˜¯æ‰§è¡Œcliçš„mainæ–¹æ³•è§£æå‘½ä»¤å‚æ•°,é»˜è®¤åˆ™æ˜¯å¯åŠ¨æœåŠ¡å™¨.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># odoo/cli/command.py:33</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
	<span style="color:#75715e"># ....æ­¤å¤„çœç•¥è‹¥å¹²ä»£ç </span>
    <span style="color:#75715e"># å¯ä»¥çœ‹åˆ°é»˜è®¤å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯-æˆ–è€…--å¼€å¤´çš„å‚æ•°åˆ™æ˜¯serverå‘½ä»¤å¯åŠ¨æœåŠ¡å™¨</span>
    command <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;server&#34;</span>
	<span style="color:#75715e"># ....æ­¤å¤„çœç•¥è‹¥å¹²ä»£ç </span>
    <span style="color:#66d9ef">if</span> command <span style="color:#f92672">in</span> commands:
        o <span style="color:#f92672">=</span> commands[command]()
        o<span style="color:#f92672">.</span>run(args)
    <span style="color:#66d9ef">else</span>:
        sys<span style="color:#f92672">.</span>exit(<span style="color:#e6db74">&#39;Unknow command </span><span style="color:#e6db74">%r</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> (command,))
</code></pre></div><p>æ¥ä¸‹æ¥çœ‹æœåŠ¡å™¨çš„runæ–¹æ³•, <code>odoo/cli/server.py</code> çš„runæ–¹æ³•ç›´æ¥æ˜¯æ‰§è¡Œmainå‡½æ•°,å› æ­¤çœ‹mainå‡½æ•°.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># odoo/cli/server.py</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>(args):
    <span style="color:#75715e"># æ£€æŸ¥è¿è¡Œç¯å¢ƒå’Œè§£æé…ç½®</span>
    check_root_user()
    odoo<span style="color:#f92672">.</span>tools<span style="color:#f92672">.</span>config<span style="color:#f92672">.</span>parse_config(args)
    check_postgres_user()
    report_configuration()

    config <span style="color:#f92672">=</span> odoo<span style="color:#f92672">.</span>tools<span style="color:#f92672">.</span>config

    csv<span style="color:#f92672">.</span>field_size_limit(<span style="color:#ae81ff">500</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span>)

    <span style="color:#75715e"># å¦‚æœæœ‰æŒ‡å®šæ•°æ®åº“,æ•°æ®åº“ä¸å­˜åœ¨åˆ™åˆ›å»º</span>
    preload <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">if</span> config[<span style="color:#e6db74">&#39;db_name&#39;</span>]:
        preload <span style="color:#f92672">=</span> config[<span style="color:#e6db74">&#39;db_name&#39;</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;,&#39;</span>)
        <span style="color:#66d9ef">for</span> db_name <span style="color:#f92672">in</span> preload:
            <span style="color:#66d9ef">try</span>:
                odoo<span style="color:#f92672">.</span>service<span style="color:#f92672">.</span>db<span style="color:#f92672">.</span>_create_empty_database(db_name)
            <span style="color:#66d9ef">except</span> ProgrammingError <span style="color:#66d9ef">as</span> err:
                <span style="color:#66d9ef">if</span> err<span style="color:#f92672">.</span>pgcode <span style="color:#f92672">==</span> errorcodes<span style="color:#f92672">.</span>INSUFFICIENT_PRIVILEGE:
                    _logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Could not determine if database </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> exists, &#34;</span>
                                 <span style="color:#e6db74">&#34;skipping auto-creation: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span>, db_name, err)
                <span style="color:#66d9ef">else</span>:
                    <span style="color:#66d9ef">raise</span> err
            <span style="color:#66d9ef">except</span> odoo<span style="color:#f92672">.</span>service<span style="color:#f92672">.</span>db<span style="color:#f92672">.</span>DatabaseExists:
                <span style="color:#66d9ef">pass</span>
	
    <span style="color:#75715e"># å¯¼å…¥å¯¼å‡ºç¿»è¯‘</span>
    <span style="color:#66d9ef">if</span> config[<span style="color:#e6db74">&#34;translate_out&#34;</span>]:
        export_translation()
        sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">0</span>)

    <span style="color:#66d9ef">if</span> config[<span style="color:#e6db74">&#34;translate_in&#34;</span>]:
        import_translation()
        sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">0</span>)

	<span style="color:#75715e"># æŒ‡å®šå¤šè¿›ç¨‹</span>
    <span style="color:#66d9ef">if</span> config[<span style="color:#e6db74">&#39;workers&#39;</span>]:
        odoo<span style="color:#f92672">.</span>multi_process <span style="color:#f92672">=</span> True

    stop <span style="color:#f92672">=</span> config[<span style="color:#e6db74">&#34;stop_after_init&#34;</span>]

    setup_pid_file()
    <span style="color:#75715e"># æ•²é‡ç‚¹,æœåŠ¡å™¨å¼€å§‹è¿è¡Œ</span>
    rc <span style="color:#f92672">=</span> odoo<span style="color:#f92672">.</span>service<span style="color:#f92672">.</span>server<span style="color:#f92672">.</span>start(preload<span style="color:#f92672">=</span>preload, stop<span style="color:#f92672">=</span>stop)
    sys<span style="color:#f92672">.</span>exit(rc)
</code></pre></div><p>odooæœåŠ¡å™¨å¯åŠ¨:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># odoo/service/server.py</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span>(preload<span style="color:#f92672">=</span>None, stop<span style="color:#f92672">=</span>False):
    <span style="color:#e6db74">&#34;&#34;&#34; Start the odoo http server and cron processor.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">global</span> server

    load_server_wide_modules()
    odoo<span style="color:#f92672">.</span>service<span style="color:#f92672">.</span>wsgi_server<span style="color:#f92672">.</span>_patch_xmlrpc_marshaller()

    <span style="color:#75715e"># é€‰æ‹©æœåŠ¡å™¨ç±»å‹, geventæœåŠ¡å™¨ or å¤šè¿›ç¨‹ or å¤šçº¿ç¨‹</span>
    <span style="color:#66d9ef">if</span> odoo<span style="color:#f92672">.</span>evented:
        server <span style="color:#f92672">=</span> GeventServer(odoo<span style="color:#f92672">.</span>service<span style="color:#f92672">.</span>wsgi_server<span style="color:#f92672">.</span>application)
    <span style="color:#66d9ef">elif</span> config[<span style="color:#e6db74">&#39;workers&#39;</span>]:
        <span style="color:#66d9ef">if</span> config[<span style="color:#e6db74">&#39;test_enable&#39;</span>] <span style="color:#f92672">or</span> config[<span style="color:#e6db74">&#39;test_file&#39;</span>]:
            _logger<span style="color:#f92672">.</span>warning(<span style="color:#e6db74">&#34;Unit testing in workers mode could fail; use --workers 0.&#34;</span>)

        server <span style="color:#f92672">=</span> PreforkServer(odoo<span style="color:#f92672">.</span>service<span style="color:#f92672">.</span>wsgi_server<span style="color:#f92672">.</span>application)

        <span style="color:#75715e"># Workaround for Python issue24291, fixed in 3.6 (see Python issue26721)</span>
        <span style="color:#66d9ef">if</span> sys<span style="color:#f92672">.</span>version_info[:<span style="color:#ae81ff">2</span>] <span style="color:#f92672">==</span> (<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">5</span>):
            <span style="color:#75715e"># turn on buffering also for wfile, to avoid partial writes (Default buffer = 8k)</span>
            werkzeug<span style="color:#f92672">.</span>serving<span style="color:#f92672">.</span>WSGIRequestHandler<span style="color:#f92672">.</span>wbufsize <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">else</span>:
        server <span style="color:#f92672">=</span> ThreadedServer(odoo<span style="color:#f92672">.</span>service<span style="color:#f92672">.</span>wsgi_server<span style="color:#f92672">.</span>application)

    <span style="color:#75715e"># æ•²é‡ç‚¹, ç›‘è§†æ–‡ä»¶å˜åŒ–ä»è€Œè‡ªåŠ¨é‡è½½</span>
    watcher <span style="color:#f92672">=</span> None
    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;reload&#39;</span> <span style="color:#f92672">in</span> config[<span style="color:#e6db74">&#39;dev_mode&#39;</span>]:
        <span style="color:#66d9ef">if</span> watchdog:
            watcher <span style="color:#f92672">=</span> FSWatcher()
            watcher<span style="color:#f92672">.</span>start()
        <span style="color:#66d9ef">else</span>:
            _logger<span style="color:#f92672">.</span>warning(<span style="color:#e6db74">&#34;&#39;watchdog&#39; module not installed. &#34;</span>
                            <span style="color:#e6db74">&#34;Code autoreload feature is disabled&#34;</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;werkzeug&#39;</span> <span style="color:#f92672">in</span> config[<span style="color:#e6db74">&#39;dev_mode&#39;</span>]:
        server<span style="color:#f92672">.</span>app <span style="color:#f92672">=</span> DebuggedApplication(server<span style="color:#f92672">.</span>app, evalex<span style="color:#f92672">=</span>True)

    <span style="color:#75715e"># æ•²é‡ç‚¹, å¯åŠ¨æœåŠ¡å™¨</span>
    rc <span style="color:#f92672">=</span> server<span style="color:#f92672">.</span>run(preload, stop)

    <span style="color:#75715e"># å¦‚æœæ ‡å¿— phoenix ä¸º true åˆ™åœ¨æœåŠ¡å™¨é€€å‡ºåé‡æ–°è½½å…¥</span>
    <span style="color:#75715e"># like the legend of the phoenix, all ends with beginnings</span>
    <span style="color:#66d9ef">if</span> getattr(odoo, <span style="color:#e6db74">&#39;phoenix&#39;</span>, False):
        <span style="color:#66d9ef">if</span> watcher:
            watcher<span style="color:#f92672">.</span>stop()
        _reexec()

    <span style="color:#66d9ef">return</span> rc <span style="color:#66d9ef">if</span> rc <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>
</code></pre></div><h2 id="watchdogå®ç°æ–‡ä»¶å†…å®¹æ›´æ”¹åˆ™reloadæœåŠ¡å™¨">watchdogå®ç°æ–‡ä»¶å†…å®¹æ›´æ”¹åˆ™reloadæœåŠ¡å™¨</h2>
<p>åœ¨ä¸Šé¢çš„æœåŠ¡å™¨å¯åŠ¨è¿‡ç¨‹ä¸­, å¯ä»¥çœ‹åˆ°, å¦‚æœæˆ‘ä»¬é…ç½®äº†dev_modeåŒ…å«äº†reloadé€‰é¡¹, å¹¶ä¸”watchdogå˜é‡ä¸ä¸ºç©ºçš„è¯, åˆ™ä¼šå¯åŠ¨watcherè§‚å¯Ÿæ–‡ä»¶ç³»ç»Ÿ.é‚£ä¹ˆ, watchdogåœ¨å“ªå¯¼å…¥çš„å‘¢,åœ¨æºç ä¸­æœ‰:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># odoo/service/server.py</span>
<span style="color:#66d9ef">try</span>:
    <span style="color:#f92672">import</span> watchdog
    <span style="color:#f92672">from</span> watchdog.observers <span style="color:#f92672">import</span> Observer
    <span style="color:#f92672">from</span> watchdog.events <span style="color:#f92672">import</span> FileCreatedEvent, FileModifiedEvent, FileMovedEvent
<span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ImportError</span>:
    watchdog <span style="color:#f92672">=</span> None
</code></pre></div><p>å¯ä»¥çœ‹åˆ°, å°è¯•å¯¼å…¥ <code>watchdog</code> , å¯¼å…¥å¤±è´¥åˆ™ä¸ºNone. ä¸ºæ­¤æˆ‘ä¸“é—¨å»odooçš„ <code>requirements.txt</code> çœ‹äº†ä¸‹, å¹¶æ²¡æœ‰ <code>watchdog</code> è¿™ä¸ªä¾èµ–, å½“ç„¶, <code>pip install watchdog</code> å°±å¥½äº†, ä½†æ˜¯å®˜æ–¹è¿™ä¹ˆåšæ˜¯ä¸ºå•¥å‘¢? ä¸€è„¸é»‘çº¿ğŸŒš</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯watchdogçš„äº‹ä»¶å¤„ç†äº†:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FSWatcher</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self):
        self<span style="color:#f92672">.</span>observer <span style="color:#f92672">=</span> Observer()
        <span style="color:#66d9ef">for</span> path <span style="color:#f92672">in</span> odoo<span style="color:#f92672">.</span>modules<span style="color:#f92672">.</span>module<span style="color:#f92672">.</span>ad_paths:
            _logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;Watching addons folder </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span>, path)
            <span style="color:#75715e"># æ³¨å†Œä¸ºè‡ªå·±ä¸ºwatchdogçš„äº‹ä»¶å¤„ç†</span>
            self<span style="color:#f92672">.</span>observer<span style="color:#f92672">.</span>schedule(self, path, recursive<span style="color:#f92672">=</span>True)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dispatch</span>(self, event):
        <span style="color:#66d9ef">if</span> isinstance(event, (FileCreatedEvent, FileModifiedEvent, FileMovedEvent)):
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> event<span style="color:#f92672">.</span>is_directory:
                path <span style="color:#f92672">=</span> getattr(event, <span style="color:#e6db74">&#39;dest_path&#39;</span>, event<span style="color:#f92672">.</span>src_path)
                <span style="color:#75715e"># å¦‚æœæ˜¯pyä»£ç åˆ™å°è¯•å¯¼å…¥, try æ²¡æœ‰è¯­æ³•é”™è¯¯ åˆ™ é‡å¯æœåŠ¡å™¨</span>
                <span style="color:#66d9ef">if</span> path<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#39;.py&#39;</span>) <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>basename(path)<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;.~&#39;</span>):
                    <span style="color:#66d9ef">try</span>:
                        source <span style="color:#f92672">=</span> open(path, <span style="color:#e6db74">&#39;rb&#39;</span>)<span style="color:#f92672">.</span>read() <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>
                        compile(source, path, <span style="color:#e6db74">&#39;exec&#39;</span>)
                    <span style="color:#66d9ef">except</span> FileNotFoundError:
                        _logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">&#39;autoreload: python code change detected, FileNotFound for </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span>, path)
                    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">SyntaxError</span>:
                        _logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">&#39;autoreload: python code change detected, SyntaxError in </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span>, path)
                    <span style="color:#66d9ef">else</span>:
                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> getattr(odoo, <span style="color:#e6db74">&#39;phoenix&#39;</span>, False):
                            _logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;autoreload: python code updated, autoreload activated&#39;</span>)
                            restart()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span>(self):
        self<span style="color:#f92672">.</span>observer<span style="color:#f92672">.</span>start()
        _logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;AutoReload watcher running&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">stop</span>(self):
        self<span style="color:#f92672">.</span>observer<span style="color:#f92672">.</span>stop()
        self<span style="color:#f92672">.</span>observer<span style="color:#f92672">.</span>join()
</code></pre></div><p>åœ¨ <code>__init__</code> æœ‰ä¸ªæœ‰ç‚¹æ„æ€çš„æ˜¯ <code>self.observer.schedule(self, path, recursive=True)</code> ä»£ç , æŸ¥çœ‹ <code>schedule</code> å‡½æ•°ç­¾åå¯ä»¥çœ‹åˆ°å¯¹äºç¬¬ä¸€ä¸ªå‚æ•° <strong>event_handler</strong> çš„ç±»å‹æ˜¯è¦æ±‚:</p>
<blockquote>
<p>`watchdog.events.FileSystemEventHandler` or a subclass</p>
</blockquote>
<p>è€Œ <code>watchdog.events.FileSystemEventHandler</code> çš„æ ¸å¿ƒå°±æ˜¯ <strong>dispatch</strong> æ–¹æ³•.</p>
<p>çœ‹æ¥æºç è¿™ç”¨çš„æ˜¯åŠ¨æ€è¯­è¨€çš„é¸­å­æ¨¡å‹äº†. (è¿™æ®µæœ‰ç‚¹å•°å—¦äº†)</p>
<h2 id="ä¿¡å·å¤„ç†é‡è½½æœåŠ¡å™¨">ä¿¡å·å¤„ç†é‡è½½æœåŠ¡å™¨</h2>
<p>åœ¨odooæœåŠ¡å™¨å¯åŠ¨è¿‡ç¨‹æºç ä¸­, å¯ä»¥çœ‹åˆ°odooçš„æœåŠ¡å™¨ç±»å‹æœ‰ä¸‰ç§: gevent, å¤šè¿›ç¨‹, å¤šçº¿ç¨‹.</p>
<p>è€Œé»˜è®¤çš„å°±æ˜¯å¤šçº¿ç¨‹ç‰ˆæœ¬ã€‚åœ¨å¤šçº¿ç¨‹ç‰ˆæœ¬çš„startä»£ç ä¸­ï¼Œæœ‰ä¸€æ®µä¿¡å·æ³¨å†Œä»£ç ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span>(self, stop<span style="color:#f92672">=</span>False):
        _logger<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#34;Setting signal handlers&#34;</span>)
        <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;posix&#39;</span>:
            signal<span style="color:#f92672">.</span>signal(signal<span style="color:#f92672">.</span>SIGINT, self<span style="color:#f92672">.</span>signal_handler)
            signal<span style="color:#f92672">.</span>signal(signal<span style="color:#f92672">.</span>SIGTERM, self<span style="color:#f92672">.</span>signal_handler)
            signal<span style="color:#f92672">.</span>signal(signal<span style="color:#f92672">.</span>SIGCHLD, self<span style="color:#f92672">.</span>signal_handler)
            signal<span style="color:#f92672">.</span>signal(signal<span style="color:#f92672">.</span>SIGHUP, self<span style="color:#f92672">.</span>signal_handler)
            signal<span style="color:#f92672">.</span>signal(signal<span style="color:#f92672">.</span>SIGQUIT, dumpstacks)
            signal<span style="color:#f92672">.</span>signal(signal<span style="color:#f92672">.</span>SIGUSR1, log_ormcache_stats)
        <span style="color:#66d9ef">elif</span> os<span style="color:#f92672">.</span>name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;nt&#39;</span>:
            <span style="color:#f92672">import</span> win32api
            win32api<span style="color:#f92672">.</span>SetConsoleCtrlHandler(<span style="color:#66d9ef">lambda</span> sig: self<span style="color:#f92672">.</span>signal_handler(sig, None), <span style="color:#ae81ff">1</span>)

        test_mode <span style="color:#f92672">=</span> config[<span style="color:#e6db74">&#39;test_enable&#39;</span>] <span style="color:#f92672">or</span> config[<span style="color:#e6db74">&#39;test_file&#39;</span>]
        <span style="color:#66d9ef">if</span> test_mode <span style="color:#f92672">or</span> (config[<span style="color:#e6db74">&#39;http_enable&#39;</span>] <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> stop):
            <span style="color:#75715e"># some tests need the http deamon to be available...</span>
            self<span style="color:#f92672">.</span>http_spawn()
</code></pre></div><p>è¯¥ä»£ç è¡¨ç¤ºï¼Œ å¦‚æœç³»ç»Ÿå†…æ ¸æ˜¯posix(Uni*ç³»ç»Ÿ)ï¼Œåˆ™æ³¨å†Œä¸€ç³»åˆ—ä¿¡å·å¤„ç†ã€‚</p>
<p>å¦‚æœæ˜¯ntå†…æ ¸ï¼ˆWindowsç³»ç»Ÿï¼‰ï¼Œåˆ™å°†äº‹ä»¶é»˜è®¤äº¤ç»™<strong>signal_handler</strong> å‡½æ•°å¤„ç†ã€‚</p>
<p>æ¥ä¸‹æ¥å°±çœ‹å¯¹åº”çš„ä¿¡å·å¤„ç†å‡½æ•°ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">signal_handler</span>(self, sig, frame):
        <span style="color:#66d9ef">if</span> sig <span style="color:#f92672">in</span> [signal<span style="color:#f92672">.</span>SIGINT, signal<span style="color:#f92672">.</span>SIGTERM]:
            <span style="color:#75715e"># shutdown on kill -INT or -TERM</span>
            self<span style="color:#f92672">.</span>quit_signals_received <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>quit_signals_received <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
                <span style="color:#75715e"># logging.shutdown was already called at this point.</span>
                sys<span style="color:#f92672">.</span>stderr<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#34;Forced shutdown.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
                os<span style="color:#f92672">.</span>_exit(<span style="color:#ae81ff">0</span>)
            <span style="color:#75715e"># interrupt run() to start shutdown</span>
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">KeyboardInterrupt</span>()
        <span style="color:#66d9ef">elif</span> sig <span style="color:#f92672">==</span> signal<span style="color:#f92672">.</span>SIGHUP:
            <span style="color:#75715e"># restart on kill -HUP</span>
            odoo<span style="color:#f92672">.</span>phoenix <span style="color:#f92672">=</span> True
            self<span style="color:#f92672">.</span>quit_signals_received <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
            <span style="color:#75715e"># interrupt run() to start shutdown</span>
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">KeyboardInterrupt</span>()
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ˜¯SIGHUPä¿¡å·ï¼Œåˆ™æ ‡è®°phoenixä¸ºTrueï¼ŒåŒæ—¶æŠ›å‡º <strong>KeyboardInterrupt</strong> ä¸­æ–­æœåŠ¡å™¨ï¼Œæ­¤åï¼Œå›åˆ°æˆ‘ä»¬çš„odooæœåŠ¡å™¨å¯åŠ¨è¿‡ç¨‹æºç çš„æœ€åä¸€æ®µï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#75715e"># like the legend of the phoenix, all ends with beginnings</span>
    <span style="color:#66d9ef">if</span> getattr(odoo, <span style="color:#e6db74">&#39;phoenix&#39;</span>, False):
        <span style="color:#66d9ef">if</span> watcher:
            watcher<span style="color:#f92672">.</span>stop()
        _reexec()
</code></pre></div><p>ç”±æ­¤å¯è§ï¼Œå½“odooæœåŠ¡å™¨è¿›ç¨‹æ”¶åˆ°SIGHUPä¿¡å·æ—¶ï¼Œå°†ä¼šé‡è½½odooä»£ç ã€‚</p>
<p>å¯¹æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆæ“ä½œå‘é€SIGHUPä¿¡å·ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kill -1 pid
<span style="color:#75715e"># æˆ–è€…</span>
$ kill -s SIGHUP pid
</code></pre></div><h2 id="æ³¨æ„">æ³¨æ„</h2>
<p>reloadåªæ˜¯é‡è½½äº†pythonä»£ç ï¼Œåƒxmlè¿™äº›è§†å›¾é…ç½®çš„ï¼Œè¿˜æ˜¯éœ€è¦å»å‡çº§æ¨¡å—æ‰èƒ½å¤Ÿæ›´æ–°çš„ï¼Œä½†æ˜¯å¯ä»¥ç”¨deployå‘½ä»¤é…åˆã€‚</p>




      
        <div class="blog-tags">
          
            <a
              href="https://eoyohe.cn/tags/python/"
              >python</a
            >&nbsp;
          
            <a
              href="https://eoyohe.cn/tags/odoo/"
              >odoo</a
            >&nbsp;
          
        </div>
      

      
    </article>
    
    
      

    
  </div>

    <footer>
  

<div class="social-icons">
  

  
</div>


  
  <div class="container">
    <p class="credits copyright">
      <a href="https://eoyohe.cn/about"></a>
      &nbsp;&copy;
      2017 - 
      2021
      
        &nbsp;/&nbsp;
        <a href="https://eoyohe.cn/">ç²¤ICPå¤‡2022033411å·</a>
      
      &nbsp;&ndash;&nbsp;
      <em class="fas fa-moon" id="dark-mode-toggle"></em>
    </p>
  </div>
</footer>

  </body>
</html>
